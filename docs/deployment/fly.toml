# Fly.io Configuration - MicroCrop Backend API
# Deploy: fly launch --no-deploy, then fly deploy

app = "microcrop-backend-api"
primary_region = "jnb"  # Johannesburg, South Africa (closest to Kenya)

[build]
  builder = "paketobuildpacks/builder:base"
  buildpacks = ["gcr.io/paketo-buildpacks/python"]

[env]
  PORT = "8000"
  PYTHON_VERSION = "3.10"
  ENVIRONMENT = "production"
  LOG_LEVEL = "INFO"
  
  # API Configuration
  BACKEND_API_TOKEN_ALGORITHM = "HS256"
  BACKEND_API_TOKEN_EXPIRE_MINUTES = "60"
  
  # WeatherXM
  WEATHERXM_API_KEY = "154184a5-6634-405b-b237-b7d1e83557d3"
  WEATHERXM_API_URL = "https://pro.weatherxm.com/api/v1"
  
  # IPFS/Pinata
  PINATA_GATEWAY = "maroon-careful-wren-616.mypinata.cloud"
  
  # Blockchain
  BLOCKCHAIN_RPC_URL = "https://mainnet.base.org"
  BLOCKCHAIN_CHAIN_ID = "8453"
  
  # Biomass Thresholds
  BIOMASS_BASELINE_WINDOW_DAYS = "30"
  BIOMASS_HEALTHY_THRESHOLD = "0.65"
  BIOMASS_MODERATE_STRESS = "0.50"
  BIOMASS_SEVERE_STRESS = "0.35"
  
  # Damage Assessment
  DAMAGE_WEATHER_WEIGHT = "0.6"
  DAMAGE_SATELLITE_WEIGHT = "0.4"

# HTTP Service Configuration
[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = true  # Stop machines when idle (save costs)
  auto_start_machines = true  # Start on request
  min_machines_running = 1
  processes = ["app"]

  # Health checks
  [[http_service.checks]]
    interval = "30s"
    timeout = "5s"
    grace_period = "10s"
    method = "GET"
    path = "/health"

# TCP Service (alternative to http_service)
[[services]]
  protocol = "tcp"
  internal_port = 8000
  processes = ["app"]

  # HTTP on port 80
  [[services.ports]]
    port = 80
    handlers = ["http"]
    force_https = true

  # HTTPS on port 443
  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  # Health check
  [services.concurrency]
    type = "connections"
    hard_limit = 1000
    soft_limit = 800

# Process Configuration
[processes]
  app = "cd data-processor && uvicorn src.api.app:app --host 0.0.0.0 --port 8000 --workers 2"

# VM Resources
[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512  # Increase to 1024 for production

# Deployment Strategy
[deploy]
  strategy = "rolling"  # Zero-downtime rolling updates
  
# Metrics
[metrics]
  port = 9091  # Prometheus metrics endpoint
  path = "/metrics"

# Region Configuration (add more for global deployment)
# Uncomment to deploy to multiple regions:
# [regions]
#   jnb = true  # Johannesburg (primary - closest to Kenya)
#   iad = true  # US East (Virginia)
#   ams = true  # Europe (Amsterdam)

# Secrets (set with: fly secrets set KEY=value)
# Required secrets:
# - DATABASE_URL (Timescale Cloud connection string)
# - REDIS_URL (Upstash Redis or Fly Redis)
# - CELERY_BROKER_URL (same as REDIS_URL)
# - CELERY_RESULT_BACKEND (same as REDIS_URL)
# - PLANET_API_KEY
# - GCS_BUCKET_NAME
# - GCS_CREDENTIALS (JSON string)
# - BACKEND_API_TOKEN_SECRET (generate with: openssl rand -hex 32)
# - PINATA_JWT
