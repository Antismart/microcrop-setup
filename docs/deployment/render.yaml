# Render Blueprint - MicroCrop Backend
# Complete configuration for deploying to Render
# Deploy: Push to GitHub, then New â†’ Blueprint in Render dashboard

services:
  # Backend API (Python FastAPI)
  - type: web
    name: microcrop-backend-api
    runtime: python
    region: oregon
    plan: starter  # $7/month (upgrade to standard $25/month for production)
    branch: main
    rootDir: data-processor
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn src.api.app:app --host 0.0.0.0 --port $PORT --workers 2
    envVars:
      - key: PYTHON_VERSION
        value: "3.10"
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_URL
        fromDatabase:
          name: microcrop-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: PLANET_API_KEY
        sync: false  # Set manually in dashboard
      - key: GCS_BUCKET_NAME
        sync: false  # Set manually
      - key: GCS_CREDENTIALS
        sync: false  # Set manually as JSON
      - key: BACKEND_API_TOKEN_SECRET
        generateValue: true  # Auto-generate secure 32-char secret
      - key: BACKEND_API_TOKEN_ALGORITHM
        value: HS256
      - key: BACKEND_API_TOKEN_EXPIRE_MINUTES
        value: "60"
      - key: WEATHERXM_API_KEY
        value: 154184a5-6634-405b-b237-b7d1e83557d3
      - key: WEATHERXM_API_URL
        value: https://pro.weatherxm.com/api/v1
      - key: PINATA_JWT
        sync: false  # Set manually
      - key: PINATA_GATEWAY
        value: maroon-careful-wren-616.mypinata.cloud
      - key: BLOCKCHAIN_RPC_URL
        value: https://mainnet.base.org
      - key: BLOCKCHAIN_CHAIN_ID
        value: "8453"
      - key: BIOMASS_BASELINE_WINDOW_DAYS
        value: "30"
      - key: BIOMASS_HEALTHY_THRESHOLD
        value: "0.65"
      - key: BIOMASS_MODERATE_STRESS
        value: "0.50"
      - key: BIOMASS_SEVERE_STRESS
        value: "0.35"
      - key: DAMAGE_WEATHER_WEIGHT
        value: "0.6"
      - key: DAMAGE_SATELLITE_WEIGHT
        value: "0.4"
    healthCheckPath: /health
    autoDeploy: true

  # Celery Worker (Background tasks)
  - type: worker
    name: microcrop-celery-worker
    runtime: python
    region: oregon
    plan: starter  # $7/month (upgrade for more workers)
    branch: main
    rootDir: data-processor
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A src.workers.celery_app worker --loglevel=info --concurrency=2
    envVars:
      - key: PYTHON_VERSION
        value: "3.10"
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_URL
        fromDatabase:
          name: microcrop-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: PLANET_API_KEY
        sync: false
      - key: GCS_BUCKET_NAME
        sync: false
      - key: GCS_CREDENTIALS
        sync: false
      - key: BACKEND_API_TOKEN_SECRET
        sync: false
      - key: WEATHERXM_API_KEY
        value: 154184a5-6634-405b-b237-b7d1e83557d3
      - key: BLOCKCHAIN_RPC_URL
        value: https://mainnet.base.org
    autoDeploy: true

  # Celery Beat (Scheduled tasks)
  - type: worker
    name: microcrop-celery-beat
    runtime: python
    region: oregon
    plan: starter  # $7/month
    branch: main
    rootDir: data-processor
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A src.workers.celery_app beat --loglevel=info
    envVars:
      - key: PYTHON_VERSION
        value: "3.10"
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_URL
        fromDatabase:
          name: microcrop-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: microcrop-redis
          property: connectionString
      - key: PLANET_API_KEY
        sync: false
      - key: GCS_BUCKET_NAME
        sync: false
      - key: GCS_CREDENTIALS
        sync: false
    autoDeploy: true

databases:
  - name: microcrop-db
    databaseName: microcrop
    user: microcrop
    plan: starter  # $7/month (100GB storage, 1GB RAM)
    region: oregon
    ipAllowList: []  # Empty = allow all (Render services auto-whitelisted)
    # Note: For TimescaleDB, use Timescale Cloud instead and set DATABASE_URL manually

# Redis instance
redis:
  - name: microcrop-redis
    plan: starter  # $7/month (100MB, shared CPU)
    region: oregon
    maxmemoryPolicy: allkeys-lru  # Evict oldest keys when full (good for caching)
    ipAllowList: []  # Empty = allow all Render services
